<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Blockchain Tax Registry DApp</title>
<style>
  /* ======= CSS Styles ======= */
  body {
    font-family: Arial, sans-serif;
    margin: 20px auto;
    max-width: 600px;
    background: #f5f7fa;
    color: #333;
  }
  h1, h2, h3 {
    margin-top: 0;
  }
  button, input {
    padding: 8px;
    margin-top: 5px;
    width: 100%;
    box-sizing: border-box;
    font-size: 1rem;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  button {
    cursor: pointer;
    background-color: #007bff;
    border-color: #007bff;
    color: white;
    font-weight: bold;
    transition: background-color 0.3s ease;
  }
  button:hover:not(:disabled) {
    background-color: #0056b3;
  }
  button:disabled {
    opacity: 0.5;
    cursor: default;
  }
  section {
    background: white;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
  }
  .hidden {
    display: none;
  }
  #log {
    background: #fafafa;
    padding: 10px;
    border: 1px solid #ccc;
    height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 0.9rem;
  }
  pre {
    background: #f0f0f0;
    padding: 10px;
    border-radius: 4px;
    overflow-x: auto;
    font-family: monospace;
  }
</style>
</head>
<body>

<h1>Blockchain Tax Registry</h1>

<button id="connectWalletBtn">Connect MetaMask Wallet</button>
<p><strong>Connected Address:</strong> <span id="userAddress">Not connected</span></p>

<section id="adminSection" class="hidden">
  <h2>Admin Controls</h2>

  <h3>Register Taxpayer</h3>
  <input type="text" id="registerAddress" placeholder="Taxpayer Ethereum Address" />
  <input type="text" id="registerName" placeholder="Taxpayer Name" />
  <button id="registerBtn">Register Taxpayer</button>
  <div id="registerStatus"></div>

  <h3>View Taxpayer Info</h3>
  <input type="text" id="viewAddress" placeholder="Taxpayer Ethereum Address" />
  <button id="viewTaxpayerBtn">View Taxpayer Info</button>
  <pre id="taxpayerInfo"></pre>

  <h3>Withdraw Funds</h3>
  <input type="text" id="withdrawAddress" placeholder="Recipient Ethereum Address" />
  <input type="number" id="withdrawAmount" placeholder="Amount in ETH" step="0.0001" min="0" />
  <button id="withdrawBtn">Withdraw</button>
  <div id="withdrawStatus"></div>
</section>

<section id="taxpayerSection" class="hidden">
  <h2>Taxpayer Functions</h2>

  <h3>Pay Tax</h3>
  <input type="number" id="taxAmount" placeholder="Amount in ETH" step="0.0001" min="0" />
  <button id="payTaxBtn">Pay Tax</button>
  <div id="payStatus"></div>

  <h3>View My Tax Info</h3>
  <button id="myTaxInfoBtn">Get My Tax Info</button>
  <pre id="myTaxInfo"></pre>
</section>

<h3>Log</h3>
<div id="log"></div>

<!-- Ethers.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>

<script>
  // ======= JavaScript Code =======

  // TODO: Replace with your deployed smart contract address
  const contractAddress = "REPLACE_WITH_YOUR_CONTRACT_ADDRESS";

  // TODO: Replace with your smart contract ABI array
  const contractABI = [
    // Paste your contract ABI JSON here
    // Example:
    // {
    //   "inputs": [...],
    //   "name": "...",
    //   "outputs": [...],
    //   "stateMutability": "...",
    //   "type": "function"
    // },
  ];

  let provider, signer, contract, userAddress;
  const logDiv = document.getElementById('log');

  // Utility: log messages to the log div and console
  function log(message) {
    console.log(message);
    logDiv.textContent += message + "\n";
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  // Disconnect all UI sections
  function resetUI() {
    document.getElementById('userAddress').textContent = "Not connected";
    document.getElementById('adminSection').classList.add('hidden');
    document.getElementById('taxpayerSection').classList.add('hidden');
    document.getElementById('registerStatus').textContent = "";
    document.getElementById('withdrawStatus').textContent = "";
    document.getElementById('payStatus').textContent = "";
    document.getElementById('taxpayerInfo').textContent = "";
    document.getElementById('myTaxInfo').textContent = "";
  }

  // Connect to MetaMask wallet
  async function connectWallet() {
    if (typeof window.ethereum === 'undefined') {
      alert("MetaMask is not installed. Please install MetaMask extension and refresh.");
      return;
    }

    try {
      await ethereum.request({ method: 'eth_requestAccounts' });
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();

      document.getElementById('userAddress').textContent = userAddress;
      log("Connected wallet: " + userAddress);

      contract = new ethers.Contract(contractAddress, contractABI, signer);

      // Check if connected user is admin (contract owner)
      const adminAddress = await contract.admin ? await contract.admin() : await contract.owner();
      if(adminAddress && userAddress.toLowerCase() === adminAddress.toLowerCase()) {
        log("User is Admin");
        document.getElementById('adminSection').classList.remove('hidden');
      } else {
        log("User is Taxpayer");
      }

      document.getElementById('taxpayerSection').classList.remove('hidden');

    } catch (error) {
      alert("Failed to connect wallet: " + (error.data?.message || error.message));
      log("Error connecting wallet: " + error.message);
    }
  }

  // Admin: Register taxpayer
  async function registerTaxpayer() {
    const addr = document.getElementById('registerAddress').value.trim();
    const name = document.getElementById('registerName').value.trim();
    const status = document.getElementById('registerStatus');

    if (!ethers.utils.isAddress(addr)) {
      alert("Invalid Ethereum address for taxpayer.");
      return;
    }
    if (name === "") {
      alert("Please input a taxpayer name.");
      return;
    }

    try {
      status.textContent = "Sending transaction...";
      const tx = await contract.registerTaxpayer(addr, name);
      await tx.wait();
      status.textContent = "Taxpayer registered successfully!";
      log(`Registered taxpayer: ${name} (${addr})`);
      // Clear inputs
      document.getElementById('registerAddress').value = "";
      document.getElementById('registerName').value = "";
    } catch (error) {
      status.textContent = "Error: " + (error.data?.message || error.message);
      log("Register taxpayer error: " + (error.data?.message || error.message));
    }
  }

  // Admin: View taxpayer info by address
  async function viewTaxpayerInfo() {
    const addrInput = document.getElementById('viewAddress').value.trim();
    const infoBox = document.getElementById('taxpayerInfo');
    infoBox.textContent = "";

    if (!ethers.utils.isAddress(addrInput)) {
      alert("Invalid Ethereum address.");
      return;
    }
    try {
      const info = await contract.getTaxpayerInfo(addrInput);
      const [name, totalPaid, lastPayment] = info;
      const ethPaid = ethers.utils.formatEther(totalPaid);
      const lastPaymentDate = lastPayment.toNumber() === 0 ? "No payments" : new Date(lastPayment.toNumber() * 1000).toLocaleString();
      infoBox.textContent =
        `Name: ${name}\n` +
        `Total Paid: ${ethPaid} ETH\n` +
        `Last Payment: ${lastPaymentDate}`;
      log(`Viewed taxpayer info for ${addrInput}`);
    } catch (error) {
      infoBox.textContent = "Error: " + (error.data?.message || error.message);
      log("View taxpayer info error: " + (error.data?.message || error.message));
    }
  }

  // Admin: Withdraw collected funds
  async function withdrawFunds() {
    const toAddr = document.getElementById('withdrawAddress').value.trim();
    const amountEth = document.getElementById('withdrawAmount').value.trim();
    const status = document.getElementById('withdrawStatus');

    if (!ethers.utils.isAddress(toAddr)) {
      alert("Invalid recipient Ethereum address.");
      return;
    }
    if (isNaN(amountEth) || Number(amountEth) <= 0) {
      alert("Enter a valid amount in ETH.");
      return;
    }
    try {
      status.textContent = "Sending withdrawal transaction...";
      const amountWei = ethers.utils.parseEther(amountEth);
      const tx = await contract.withdrawFunds(toAddr, amountWei);
      await tx.wait();
      status.textContent = "Withdrawal successful!";
      log(`Withdrew ${amountEth} ETH to ${toAddr}`);
      // Clear inputs
      document.getElementById('withdrawAddress').value = "";
      document.getElementById('withdrawAmount').value = "";
    } catch (error) {
      status.textContent = "Withdrawal failed: " + (error.data?.message || error.message);
      log("Withdraw funds error: " + (error.data?.message || error.message));
    }
  }

  // Taxpayer: Pay tax
  async function payTax() {
    const amountEth = document.getElementById('taxAmount').value.trim();
    const status = document.getElementById('payStatus');

    if (isNaN(amountEth) || Number(amountEth) <= 0) {
      alert("Enter a valid amount greater than zero.");
      return;
    }
    try {
      status.textContent = "Sending payment transaction...";
      const tx = await contract.payTax({ value: ethers.utils.parseEther(amountEth) });
      await tx.wait();
      status.textContent = "Tax payment successful!";
      log(`Paid ${amountEth} ETH in tax.`);
      document.getElementById('taxAmount').value = "";
    } catch (error) {
      status.textContent = "Payment failed: " + (error.data?.message || error.message);
      log("Pay tax error: " + (error.data?.message || error.message));
    }
  }

  // Taxpayer: View own tax info
  async function getMyTaxInfo() {
    const infoBox = document.getElementById('myTaxInfo');
    infoBox.textContent = "";

    try {
      const info = await contract.getMyTaxInfo();
      const [name, totalPaid, lastPayment] = info;
      const ethPaid = ethers.utils.formatEther(totalPaid);
      const lastPaymentDate = lastPayment.toNumber() === 0 ? "No payments" : new Date(lastPayment.toNumber() * 1000).toLocaleString();
      infoBox.textContent =
        `Name: ${name}\n` +
        `Total Paid: ${ethPaid} ETH\n` +
        `Last Payment: ${lastPaymentDate}`;
      log("Fetched own tax info");
    } catch (error) {
      infoBox.textContent = "Error: " + (error.data?.message || error.message);
      log("Get my tax info error: " + (error.data?.message || error.message));
    }
  }

  // Listen for MetaMask account and network changes
  if (window.ethereum) {
    window.ethereum.on('accountsChanged', (accounts) => {
      if (accounts.length === 0) {
        alert("MetaMask disconnected. Please connect your wallet again.");
        resetUI();
      } else {
        userAddress = accounts[0];
        document.getElementById('userAddress').textContent = userAddress;
        log("Account changed to " + userAddress);
        window.location.reload();
      }
    });

    window.ethereum.on('chainChanged', (_chainId) => {
      alert("Network changed, reloading...");
      window.location.reload();
    });
  }

  // Attach event handlers after DOM is loaded
  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
    document.getElementById('registerBtn').addEventListener('click', registerTaxpayer);
    document.getElementById('viewTaxpayerBtn').addEventListener('click', viewTaxpayerInfo);
    document.getElementById('withdrawBtn').addEventListener('click', withdrawFunds);
    document.getElementById('payTaxBtn').addEventListener('click', payTax);
    document.getElementById('myTaxInfoBtn').addEventListener('click', getMyTaxInfo);
    resetUI();
  });

</script>

</body>
</html>
